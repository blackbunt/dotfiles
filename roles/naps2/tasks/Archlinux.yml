---
- name: Naps2 | Install Naps2 & sane-airscan
  block:
    - name: Naps2 | Check if sane-airscan is installed
      ansible.builtin.command:
        cmd: "pacman -Q sane-airscan"
      register: sane_airscan_installed
      changed_when: false
      failed_when: false
      become: true

    - name: Naps2 | Install sane-airscan via pacman
      pacman:
        name: sane-airscan
        state: present
        update_cache: true
      become: true
      when: sane_airscan_installed.rc != 0

    - name: Naps2 | Check if yay is installed
      ansible.builtin.command:
        cmd: "which yay"
      register: yay_installed
      changed_when: false
      failed_when: yay_installed.rc != 0

    - name: Naps2 | Install yay if not present
      block:
        - name: Naps2 | Install base-devel and git
          pacman:
            name:
              - base-devel
              - git
            state: present
            update_cache: true
          become: true

        - name: Naps2 | Clone yay repository
          ansible.builtin.git:
            repo: "https://aur.archlinux.org/yay.git"
            dest: "/tmp/yay"
            version: master
          when: yay_installed.rc != 0

        - name: Naps2 | Build and install yay
          ansible.builtin.command:
            cmd: "makepkg -si --noconfirm"
            chdir: "/tmp/yay"
          when: yay_installed.rc != 0
          become: false
      when: yay_installed.rc != 0

    - name: Naps2 | Check if naps2 is installed
      ansible.builtin.command:
        cmd: "yay -Q naps2"
      register: naps2_installed
      changed_when: false
      failed_when: false
      when: yay_installed.rc == 0

    - name: Naps2 | Clean yay cache for NAPS2
      ansible.builtin.command:
        cmd: "yay -Scc --noconfirm"
      changed_when: true
      become: false
      when: yay_installed.rc == 0 and naps2_installed.rc != 0

    - name: Naps2 | Install naps2 via yay
      ansible.builtin.command:
        cmd: "yay -S --noconfirm naps2"
      changed_when: true
      become: false
      when: yay_installed.rc == 0 and naps2_installed.rc != 0
