---
- name: OnlyOffice | Install OnlyOffice Desktop Suite
  become: true
  block:
    - name: OnlyOffice | Check if OnlyOffice is installed
      ansible.builtin.command:
        cmd: "pacman -Q onlyoffice-bin"
      register: onlyoffice_installed
      changed_when: false
      failed_when: false

    - name: OnlyOffice | Check if yay is installed
      ansible.builtin.command:
        cmd: "which yay"
      register: yay_installed
      changed_when: false
      failed_when: yay_installed.rc != 0

    - name: OnlyOffice | Install yay if not present
      block:
        - name: OnlyOffice | Install base-devel and git
          pacman:
            name:
              - base-devel
              - git
            state: present
            update_cache: true

        - name: OnlyOffice | Clone yay repository
          ansible.builtin.git:
            repo: "https://aur.archlinux.org/yay.git"
            dest: "/tmp/yay"
            version: master
          when: yay_installed.rc != 0

        - name: OnlyOffice | Build and install yay
          ansible.builtin.command:
            cmd: "makepkg -si --noconfirm"
            chdir: "/tmp/yay"
          when: yay_installed.rc != 0
          become: false  # AUR-Pakete sollten nicht als Root gebaut werden
      when: yay_installed.rc != 0

    - name: OnlyOffice | Install OnlyOffice via yay
      ansible.builtin.command:
        cmd: "yay -S --noconfirm onlyoffice-bin"
      changed_when: true
      become: false
      when: yay_installed.rc == 0 and onlyoffice_installed.rc != 0
